var mv=353,stupid=eval("window.attachEvent")?1:0,hosts,idle_timeout=20,erase_timeout=35,skew_x=0;skew_y=0;var listening=1,wiviz_cgi_url="/cgi-bin/wiviz/get.cgi";function scan_thread(){var e=document.getElementById("wivizGetFrame").contentWindow.location;listening&&(e.href!=wiviz_cgi_url?e.replace(wiviz_cgi_url):e.reload(!0),setTimeout("scan_thread()",5E3))}
function toggleListen(){statusel=document.getElementById("status");statusbutton=document.getElementById("togglelisten");(listening=1-listening)?(statusel.innerHTML="Monitoring",statusbutton.value="Stop monitoring",document.getElementById("content").innerHTML="",scan_thread()):(statusel.innerHTML="Stopped",statusbutton.value="Start monitoring")}
function channelSet(){channelset=document.getElementById("channelsel").value;"hop"==channelset?document.getElementById("hopoptions").style.display="inline":(document.getElementById("hopoptions").style.display="none","nochange"!=channelset&&document.forms[0].submit())}function mousenter(e){stupid&&(e=event);el=stupid?e.srcElement:e.currentTarget;el.parentNode.parentNode.className="hostdiv_hov";el.nextSibling.nextSibling.nextSibling.style.visibility="visible"}
function mouseout(e){stupid&&(e=event);el=stupid?e.srcElement:e.currentTarget;el.parentNode.parentNode.className="hostdiv";el.nextSibling.nextSibling.nextSibling.style.visibility="hidden"}function generate_mnemonic(e){c="b c d f g h j k l m n p qu r s t v w y z th ch sh cc rr".split(" ");v="a e i o u ae ai ao au eo ei eu iu oa oe".split(" ");var b,f,g=e&1,h="";for(b=0;4>b;b++)f=g?c:v,h+=f[e%f.length],e+=f.length<<3+f.length/2,e*=e,g=1-g;return h}
function mkhash(e){e=e.split(/:/);var b=0;for(j=0;6>j;j++)b+=parseInt(e[j])*j<<j,b+=11;0>b&&(b=-b);return b}
function wiviz_callback(e,b){var f="";hosts=e;for(i=0;i<hosts.length;i++){hs=hosts[i];if(0==hs.length)break;hs.mac=hs[0];hs.rssi=hs[1];hs.desc=hs[2];hs.descarr=hs.desc.split(/-/);hs.age=hs[3];hs.hash=mkhash(hs.mac);hs.mnem=generate_mnemonic(hs.hash);hs.name=hs.mnem;(el=document.getElementById(hs.mnem))?hs.age>erase_timeout?el.parentNode.removeChild(el):el.innerHTML=genHTML(hs):hs.age>erase_timeout||(hs.x=Math.sin(hs.hash/mv)*hs.rssi*2-67,hs.y=Math.cos(hs.hash/mv)*hs.rssi*2,f+="<div class='hostdiv' id='"+
hs.mnem+"' style='top: ",f+=parseInt(hs.y)+"px; left: "+parseInt(hs.x)+"px'>",f+=genHTML(hs)+"</div>")}document.getElementById("content").innerHTML+=f;cfgarr=b.split(/-/);cfgarr[1]&&("hopping"==cfgarr[1]&&(cfgarr[1]="hop"),document.getElementById("channelsel").value=cfgarr[1],"hop"==cfgarr[1]&&channelSet());setTimeout("declump(); repip();",250)}
function repip(){var e="";if(hosts){for(i=0;i<hosts.length;i++){hs=hosts[i];if(0==hs.length)break;mac=hs[0];rssi=hs[1];desc=hs[2].split(/-/);if("sta"==desc[0]&&"assoc"==desc[1]&&(bss=desc[2],hs.apmnem=generate_mnemonic(mkhash(bss)),ap=document.getElementById(hs.apmnem),sta=document.getElementById(hs.mnem),ap&&sta))for(x=parseInt(sta.style.left),y=parseInt(sta.style.top),dx=parseInt(ap.style.left)-x,dy=parseInt(ap.style.top)-y,x+=67,y+=10,d=Math.sqrt(dx*dx+dy*dy),j=0;j<d;j+=15)e+="<img src='"+(hs.age<
idle_timeout?"pip":"pip-idle")+(stupid?".gif":".png")+"' class='pip' style='top:"+parseInt(y+dy*j/d)+"; left:"+parseInt(x+dx*j/d)+"'>"}document.getElementById("pips").innerHTML=e}}
function declump(){var e=0,b=3E4,f=3E4,g=-3E4,h=-3E4;for(i=0;i<hosts.length;i++)for(j=0;j<hosts.length;j++)if(i!=j&&(e1=document.getElementById(hosts[i].mnem),e2=document.getElementById(hosts[j].mnem),e1&&e2)){x1=parseInt(e1.style.left);x2=parseInt(e2.style.left);y1=parseInt(e1.style.top);y2=parseInt(e2.style.top);x1<f&&(f=x1);y1<b&&(b=y1);x1>g&&(g=x1);y1>h&&(h=y1);ox=x2;oy=y2;dist=Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));0==dist&&(x2+=5*Math.random(),y2+=5*Math.random(),dist=10);100>dist&&
(cx=5*(x1-x2)/(dist/3),cy=5*(y1-y2)/(dist/3),x2-=cx,y2-=cy);if(hosts[j].apmnem==hosts[i].mnem||hosts[i].apmnem==hosts[j].mnem)cx=5*(x1-x2)/(dist/3),cy=5*(y1-y2)/(dist/3),150<dist&&(x2+=cx,y2+=cy);if(2<Math.abs(ox-x2)||2<Math.abs(oy-y2))e2.style.left=parseInt(x2),e2.style.top=parseInt(y2),e++}b<h&&f<g&&(document.getElementById("debug").innerHTML=f+","+g+","+b+","+h,document.getElementById("content").style.left=document.getElementById("pips").style.left=-(g-f)/2-f-67,document.getElementById("content").style.top=
document.getElementById("pips").style.top=-(h-b)/2-b-25);repip();e&&setTimeout("declump()",100)}
function genHTML(e){var b;b="<center><img class='icon' src='";a=e.descarr;"ap"==a[0]||"adhoc"==a[0]?("ap"==a[0]?(b+="ap","enc"==a[5]&&(b+="-wep")):b+="adhoc",e.channel=a[2],e.name=a[4]):"sta"==a[0]&&(b+="station",e.channel=0);b+=e.age<idle_timeout?"":"-idle";b+=stupid?".gif":".png";b+="' onmouseover='mousenter(event)' onmouseout='mouseout(event)'><br><span class='hostdesc'>"+e.mac+"<br><i>'"+e.name;b+="'</i>";e.channel&&(b+=" ch"+e.channel);b+="</span><span class='extrafo'><br>";"ap"==a[0]&&(b+="Access point");
"sta"==a[0]&&(b+="Station");"adhoc"==a[0]&&(b+="Logical ad-hoc entity");if("ap"==a[0]||"adhoc"==a[0])b+="<br>","?enc"==a[5]&&(b+="Encryption unknown"),"enc"==a[5]&&(b+="Encrypted"),"unenc"==a[5]&&(b+="Unencrypted"),"wep"==a[6]&&(b+="-WEP"),"wpa"==a[6]&&(b+="-WPA");b+="<br>RSSI: "+e.rssi+" dBm<br>Seen "+e.age+" seconds ago<br>";return b+"</span></center>"};
