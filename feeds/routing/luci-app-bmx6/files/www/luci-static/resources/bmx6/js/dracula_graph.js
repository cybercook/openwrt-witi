var AbstractEdge=function(){};AbstractEdge.prototype={hide:function(){this.connection.fg.hide();this.connection.bg&&this.bg.connection.hide()}};var EdgeFactory=function(){this.template=new AbstractEdge;this.template.style={};this.template.style.directed=!1;this.template.weight=1};EdgeFactory.prototype={build:function(a,b){var c=jQuery.extend(!0,{},this.template);c.source=a;c.target=b;return c}};var Graph=function(){this.nodes={};this.edges=[];this.snapshots=[];this.edgeFactory=new EdgeFactory};
Graph.prototype={addNode:function(a,b){void 0==this.nodes[a]&&(this.nodes[a]=new Graph.Node(a,b));return this.nodes[a]},addEdge:function(a,b,c){a=this.addNode(a);b=this.addNode(b);var d=this.edgeFactory.build(a,b);jQuery.extend(d.style,c);a.edges.push(d);this.edges.push(d);b.edges.push(d)},snapShot:function(a){},removeNode:function(a){delete this.nodes[a];for(var b=0;b<this.edges.length;b++)if(this.edges[b].source.id==a||this.edges[b].target.id==a)this.edges.splice(b,1),b--}};
Graph.Node=function(a,b){b=b||{};b.id=a;b.edges=[];b.hide=function(){this.hidden=!0;this.shape&&this.shape.hide();for(i in this.edges)(this.edges[i].source.id==a||this.edges[i].target==a)&&this.edges[i].hide&&this.edges[i].hide()};b.show=function(){this.hidden=!1;this.shape&&this.shape.show();for(i in this.edges)(this.edges[i].source.id==a||this.edges[i].target==a)&&this.edges[i].show&&this.edges[i].show()};return b};Graph.Node.prototype={};Graph.Renderer={};
Graph.Renderer.Raphael=function(a,b,c,d){this.width=c||400;this.height=d||400;var e=this;this.r=Raphael(a,this.width,this.height);this.radius=40;this.graph=b;this.mouse_in=!1;this.graph.render||(this.graph.render=function(){});this.isDrag=!1;this.dragger=function(a){this.dx=a.clientX;this.dy=a.clientY;e.isDrag=this;this.set&&this.set.animate({"fill-opacity":.1},200)&&this.set.toFront();a.preventDefault&&a.preventDefault()};a=document.getElementById(a);a.onmousemove=function(a){a=a||window.event;if(e.isDrag){var b=
e.isDrag.set.getBBox(),c=a.clientX-e.isDrag.dx+(b.x+b.width/2),b=a.clientY-e.isDrag.dy+(b.y+b.height/2),c=a.clientX-(20>c?c-20:c>e.width-20?c-e.width+20:0);a=a.clientY-(20>b?b-20:b>e.height-20?b-e.height+20:0);e.isDrag.set.translate(c-Math.round(e.isDrag.dx),a-Math.round(e.isDrag.dy));for(var d in e.graph.edges)e.graph.edges[d].connection&&e.graph.edges[d].connection.draw();e.isDrag.dx=c;e.isDrag.dy=a}};a.onmouseup=function(){e.isDrag&&e.isDrag.set.animate({"fill-opacity":.6},500);e.isDrag=!1};this.draw()};
Graph.Renderer.Raphael.prototype={translate:function(a){return[(a[0]-this.graph.layoutMinX)*this.factorX+this.radius,(a[1]-this.graph.layoutMinY)*this.factorY+this.radius]},rotate:function(a,b,c){return[a[0]+b*Math.cos(c),a[1]+b*Math.sin(c)]},draw:function(){this.factorX=(this.width-2*this.radius)/(this.graph.layoutMaxX-this.graph.layoutMinX);this.factorY=(this.height-2*this.radius)/(this.graph.layoutMaxY-this.graph.layoutMinY);for(a in this.graph.nodes)this.drawNode(this.graph.nodes[a]);for(var a=
0;a<this.graph.edges.length;a++)this.drawEdge(this.graph.edges[a])},drawNode:function(a){var b=this.translate([a.layoutPosX,a.layoutPosY]);a.point=b;if(a.shape){var c=a.shape.getBBox();a.shape.translate(Math.round(b[0]-(c.x+c.width/2)),Math.round(b[1]-(c.y+c.height/2)));this.r.safari();return a}var d;a.render||(a.render=function(a,b){var c=Raphael.getColor(),c=a.ellipse(0,0,30,20).attr({fill:c,stroke:c,"stroke-width":2});c.node.id=b.label||b.id;return d=a.set().push(c).push(a.text(0,30,b.label||b.id))});
d=a.render(this.r,a).hide();d.attr({"fill-opacity":.6});d.items.forEach(function(a){a.set=d;a.node.style.cursor="move"});d.mousedown(this.dragger);c=d.getBBox();d.translate(Math.round(b[0]-(c.x+c.width/2)),Math.round(b[1]-(c.y+c.height/2)));a.hidden||d.show();a.shape=d},drawEdge:function(a){a.backedge||(a.source.hidden||a.target.hidden?a.connection&&a.connection.fg.hide()|a.connection.bg&&a.connection.bg.hide():a.connection?(a.connection.fg.show(),a.connection.bg&&a.connection.bg.show(),a.connection.draw()):
(a.style&&a.style.callback&&a.style.callback(a),a.connection=this.r.connection(a.source.shape,a.target.shape,a.style)))}};Graph.Layout={};Graph.Layout.Spring=function(a){this.graph=a;this.iterations=500;this.maxRepulsiveForceDistance=6;this.k=2;this.c=.01;this.maxVertexMovement=.5;this.layout()};
Graph.Layout.Spring.prototype={layout:function(){this.layoutPrepare();for(var a=0;a<this.iterations;a++)this.layoutIteration();this.layoutCalcBounds()},layoutPrepare:function(){for(i in this.graph.nodes){var a=this.graph.nodes[i];a.layoutPosX=0;a.layoutPosY=0;a.layoutForceX=0;a.layoutForceY=0}},layoutCalcBounds:function(){var a=Infinity,b=-Infinity,c=Infinity,d=-Infinity;for(i in this.graph.nodes){var e=this.graph.nodes[i].layoutPosX,f=this.graph.nodes[i].layoutPosY;e>b&&(b=e);e<a&&(a=e);f>d&&(d=
f);f<c&&(c=f)}this.graph.layoutMinX=a;this.graph.layoutMaxX=b;this.graph.layoutMinY=c;this.graph.layoutMaxY=d},layoutIteration:function(){var a=[],b;for(b in this.graph.nodes){var c=this.graph.nodes[b],d;for(d in a)this.layoutRepulsive(c,this.graph.nodes[a[d]]);a.push(b)}for(a=0;a<this.graph.edges.length;a++)this.layoutAttractive(this.graph.edges[a]);for(a in this.graph.nodes){b=this.graph.nodes[a];c=this.c*b.layoutForceX;d=this.c*b.layoutForceY;var e=this.maxVertexMovement;c>e&&(c=e);c<-e&&(c=-e);
d>e&&(d=e);d<-e&&(d=-e);b.layoutPosX+=c;b.layoutPosY+=d;b.layoutForceX=0;b.layoutForceY=0}},layoutRepulsive:function(a,b){if("undefined"!=typeof a&&"undefined"!=typeof b){var c=b.layoutPosX-a.layoutPosX,d=b.layoutPosY-a.layoutPosY,e=c*c+d*d;.01>e&&(c=.1*Math.random()+.1,d=.1*Math.random()+.1,e=c*c+d*d);e=Math.sqrt(e);if(e<this.maxRepulsiveForceDistance){var f=this.k*this.k/e;b.layoutForceX+=f*c/e;b.layoutForceY+=f*d/e;a.layoutForceX-=f*c/e;a.layoutForceY-=f*d/e}}},layoutAttractive:function(a){var b=
a.source,c=a.target,d=c.layoutPosX-b.layoutPosX,e=c.layoutPosY-b.layoutPosY,f=d*d+e*e;.01>f&&(d=.1*Math.random()+.1,e=.1*Math.random()+.1,f=d*d+e*e);var g=Math.sqrt(f);g>this.maxRepulsiveForceDistance&&(g=this.maxRepulsiveForceDistance,f=g*g);f=(f-this.k*this.k)/this.k;void 0==a.attraction&&(a.attraction=1);f*=.5*Math.log(a.attraction)+1;c.layoutForceX-=f*d/g;c.layoutForceY-=f*e/g;b.layoutForceX+=f*d/g;b.layoutForceY+=f*e/g}};Graph.Layout.Ordered=function(a,b){this.graph=a;this.order=b;this.layout()};
Graph.Layout.Ordered.prototype={layout:function(){this.layoutPrepare();this.layoutCalcBounds()},layoutPrepare:function(a){for(i in this.graph.nodes)a=this.graph.nodes[i],a.layoutPosX=0,a.layoutPosY=0;var b=0;for(i in this.order)a=this.order[i],a.layoutPosX=b,a.layoutPosY=Math.random(),b++},layoutCalcBounds:function(){var a=Infinity,b=-Infinity,c=Infinity,d=-Infinity;for(i in this.graph.nodes){var e=this.graph.nodes[i].layoutPosX,f=this.graph.nodes[i].layoutPosY;e>b&&(b=e);e<a&&(a=e);f>d&&(d=f);f<
c&&(c=f)}this.graph.layoutMinX=a;this.graph.layoutMaxX=b;this.graph.layoutMinY=c;this.graph.layoutMaxY=d}};function log(a){console.log&&console.log(a)}Raphael.el.tooltip=function(a){this.tp=a;this.tp.o={x:0,y:0};this.tp.hide();this.hover(function(a){this.mousemove(function(a){this.tp.translate(a.clientX-this.tp.o.x,a.clientY-this.tp.o.y);this.tp.o={x:a.clientX,y:a.clientY}});this.tp.show().toFront()},function(a){this.tp.hide();this.unmousemove()});return this};
Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c=this.length;if("function"!=typeof a)throw new TypeError;for(var d=0;d<c;d++)d in this&&a.call(b,this[d],d,this)});
